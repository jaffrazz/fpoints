<?php
namespace api\v1\controllers;

use api\modules\JWTHttpBearer;
use api\v1\models\LoginForm;
use api\v1\models\User;
use sizeg\jwt\Jwt;
use yii;
use yii\helpers\Url;
use yii\rest\ActiveController;

class UserController extends ActiveController
{
    public $modelClass = User::class;

    public function behaviors()
    {

        $behaviors = parent::behaviors();
        $behaviors['authenticator'] = [
            'class' => JWTHttpBearer::class,
            'optional' => [
                'login',
            ],
        ];

        return $behaviors;

    }

    public function actions()
    {
        $action = parent::actions(); // TODO: Change the autogenerated stub
        unset($action['index']);
        unset($action['create']);
        unset($action['update']);
        unset($action['delete']);
    }

    public function actionIndex()
    {
        return ['success' => true];
    }

    /**
     * landing
     * @return array
     * @throws \yii\base\Exception
     * @throws \yii\base\InvalidConfigException
     */
    public function actionOauth()
    {
        $model = new LoginForm();
        if ($model->load(Yii::$app->getRequest()->getBodyParams(), '') && $model->login()) {
            /** @var Jwt $jwt */
            $user = User::findByUsername($model->username);
            $jwt = Yii::$app->jwt;
            $signer = $jwt->getSigner('HS256');
            $key = $jwt->getKey();
            $time = time();

            // Adoption for lcobucci/jwt ^4.0 version
            $token = $jwt->getBuilder()
                ->issuedBy(Url::base(true)) // Configures the issuer (iss claim)
                ->permittedFor(Url::base(true)) // Configures the audience (aud claim)
                ->identifiedBy('3L3337#(0_0)', true) // Configures the id (jti claim), replicating as a header item
                ->issuedAt($time) // Configures the time that the token was issue (iat claim)
                ->expiresAt($time + (3600 * 2)) // Configures the expiration time of the token (exp claim)
                ->withClaim('uid', $user->id) // Configures a new claim, called "uid"
                ->getToken($signer, $key); // Retrieves the generated token

            $user->access_token = (string) $token;
            $user->save(0);

            return [
                'access_token' => (string) $user->access_token,

            ];
        } else {
            return $model->getFirstErrors();
        }
    }
}
